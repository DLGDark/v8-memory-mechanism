<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>内存指标 | 揭秘V8内存神秘面纱</title>
    <meta name="description" content="v8-memory-mechanism">
    <link rel="icon" href="/v8-memory-mechanism/content/favicon.ico">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/v8-memory-mechanism/assets/css/0.styles.24131f21.css" as="style"><link rel="preload" href="/v8-memory-mechanism/assets/js/app.f97e74ef.js" as="script"><link rel="preload" href="/v8-memory-mechanism/assets/js/2.086987ff.js" as="script"><link rel="preload" href="/v8-memory-mechanism/assets/js/9.faddb988.js" as="script"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/10.98769fd7.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/11.944a39db.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/12.eae54814.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/13.d925417d.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/14.d7495123.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/15.49bd0c91.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/16.78523aea.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/3.dbef74a1.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/4.b6213a41.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/5.9360fc3d.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/6.8089035a.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/7.618484f5.js"><link rel="prefetch" href="/v8-memory-mechanism/assets/js/8.3d306d96.js">
    <link rel="stylesheet" href="/v8-memory-mechanism/assets/css/0.styles.24131f21.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/v8-memory-mechanism/" class="home-link router-link-active"><!----> <span class="site-name">揭秘V8内存神秘面纱</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/v8-memory-mechanism/start/" class="nav-link">正文</a></div><div class="nav-item"><a href="/v8-memory-mechanism/furtherReading/" class="nav-link router-link-active">拓展阅读</a></div><div class="nav-item"><a href="/v8-memory-mechanism/about/" class="nav-link">关于</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/v8-memory-mechanism/start/" class="nav-link">正文</a></div><div class="nav-item"><a href="/v8-memory-mechanism/furtherReading/" class="nav-link router-link-active">拓展阅读</a></div><div class="nav-item"><a href="/v8-memory-mechanism/about/" class="nav-link">关于</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>拓展阅读</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/v8-memory-mechanism/furtherReading/" class="sidebar-link">高效使用内存</a></li><li><a href="/v8-memory-mechanism/furtherReading/MemoryIndicators.html" class="active sidebar-link">内存指标</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/v8-memory-mechanism/furtherReading/MemoryIndicators.html#查看内存使用情况" class="sidebar-link">查看内存使用情况</a></li><li class="sidebar-sub-header"><a href="/v8-memory-mechanism/furtherReading/MemoryIndicators.html#堆外内存" class="sidebar-link">堆外内存</a></li><li class="sidebar-sub-header"><a href="/v8-memory-mechanism/furtherReading/MemoryIndicators.html#总结" class="sidebar-link">总结</a></li></ul></li><li><a href="/v8-memory-mechanism/furtherReading/LargeMemoryApplication.html" class="sidebar-link">大内存应用</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="内存指标"><a href="#内存指标" class="header-anchor">#</a> 内存指标</h1> <p>一般而言，应用中存在一些全局性的对象是正常的，而且在正常的使用中，变量都会自动释放回收。但是也会存在一些我们认为会回收但是却没有被回收的对象，这会导致内存占用无限增长。一旦增长达到V8的内存限制，将会得到内存溢出错误，进而导致进程退出。</p> <h2 id="查看内存使用情况"><a href="#查看内存使用情况" class="header-anchor">#</a> 查看内存使用情况</h2> <p>前面我们提到了process.memoryUsage()可以查看内存使用情况。除此之外，os模块中的totalmem()和freemem()方法也可以查看内存使用情况。</p> <h4 id="_1-查看进程的内存占用"><a href="#_1-查看进程的内存占用" class="header-anchor">#</a> 1.查看进程的内存占用</h4> <p>调用process.memoryUsage()可以看到Node进程的内存占用情况，示例代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&gt;</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span> rss<span class="token punctuation">:</span> <span class="token number">22904832</span><span class="token punctuation">,</span>
  heapTotal<span class="token punctuation">:</span> <span class="token number">9682944</span><span class="token punctuation">,</span>
  heapUsed<span class="token punctuation">:</span> <span class="token number">5424960</span><span class="token punctuation">,</span>
  external<span class="token punctuation">:</span> <span class="token number">8858</span> <span class="token punctuation">}</span>
</code></pre></div><p>rss是resident set size的缩写，即进程的常驻内存部分。进程的内存总共有几部分，一部分是rss，其余部分在交换区(swap)或者文件系统(filesystem)中。
除了rss外，heapTotal和heapUsed对应的是V8的堆内存信息。heapTotal是堆中总共申请的内存量，heapUsed表示目前堆中使用中的内存量。这3个值的单位都是字节。</p> <p>为了更好地查看效果，我们格式化一下输出结果：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">showMem</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> mem <span class="token operator">=</span> process<span class="token punctuation">.</span><span class="token function">memoryUsage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> <span class="token function-variable function">format</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">bytes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span>bytes <span class="token operator">/</span> <span class="token number">1024</span> <span class="token operator">/</span> <span class="token number">1024</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toFixed</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' MB'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Process: heapTotal '</span> <span class="token operator">+</span> <span class="token function">format</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span>heapTotal<span class="token punctuation">)</span> <span class="token operator">+</span><span class="token string">' heapUsed '</span> <span class="token operator">+</span> <span class="token function">format</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span>heapUsed<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' rss '</span> <span class="token operator">+</span> <span class="token function">format</span><span class="token punctuation">(</span>mem<span class="token punctuation">.</span>rss<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'----------------------------------------------'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>同时，写一个方法用于不停地分配内存但不释放内存，相关代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">useMem</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">20</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> arr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    arr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> arr<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> total <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">showMem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  total<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">useMem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token function">showMem</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>将以上代码存为outOfMemory.js并执行它，得到的输出结果如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Process<span class="token punctuation">:</span> heapTotal <span class="token number">6.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.82</span> <span class="token constant">MB</span> rss <span class="token number">19.36</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">168.25</span> <span class="token constant">MB</span> heapUsed <span class="token number">164.52</span> <span class="token constant">MB</span> rss <span class="token number">180.99</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">328.26</span> <span class="token constant">MB</span> heapUsed <span class="token number">324.52</span> <span class="token constant">MB</span> rss <span class="token number">341.39</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">488.27</span> <span class="token constant">MB</span> heapUsed <span class="token number">484.53</span> <span class="token constant">MB</span> rss <span class="token number">501.91</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">648.28</span> <span class="token constant">MB</span> heapUsed <span class="token number">644.53</span> <span class="token constant">MB</span> rss <span class="token number">662.30</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">808.29</span> <span class="token constant">MB</span> heapUsed <span class="token number">804.53</span> <span class="token constant">MB</span> rss <span class="token number">822.65</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">968.30</span> <span class="token constant">MB</span> heapUsed <span class="token number">964.53</span> <span class="token constant">MB</span> rss <span class="token number">983.00</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">1130.32</span> <span class="token constant">MB</span> heapUsed <span class="token number">1123.70</span> <span class="token constant">MB</span> rss <span class="token number">1143.85</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">1290.33</span> <span class="token constant">MB</span> heapUsed <span class="token number">1283.70</span> <span class="token constant">MB</span> rss <span class="token number">1304.19</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
<span class="token operator">...</span><span class="token operator">...</span>
<span class="token constant">FATAL</span> <span class="token constant">ERROR</span><span class="token punctuation">:</span> <span class="token constant">CALL_AND_RETRY_LAST</span> Allocation failed <span class="token operator">-</span> JavaScript heap out <span class="token keyword">of</span> memory
</code></pre></div><p>可以看到，每次调用useMem都导致了3个值的增长。在接近1500 MB的时候，无法继续分配内存，然后进程内存溢出了，连循环体都无法执行完成，仅执行了8次。</p> <h4 id="_2-查看系统的内存占用"><a href="#_2-查看系统的内存占用" class="header-anchor">#</a> 2.查看系统的内存占用</h4> <p>与process.memoryUsage()不同的是，os模块中的totalmem()和freemem()这两个方法用于查看操作系统的内存使用情况，它们分别返回系统的总内存和闲置内存，以字节为单位。示例代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&gt;</span> os<span class="token punctuation">.</span><span class="token function">totalmem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">8580620288</span>
<span class="token operator">&gt;</span> os<span class="token punctuation">.</span><span class="token function">freemem</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token number">3807412224</span>
</code></pre></div><p>从输出的信息可以看到我的电脑的总内存为8GB，当前闲置的内存大致为3.5GB。</p> <h2 id="堆外内存"><a href="#堆外内存" class="header-anchor">#</a> 堆外内存</h2> <p>通过process.memoryUsage()的结果可以看到，堆中的内存用量总是小于进程的常驻内存用量，这意味着Node中的内存使用并非都是通过V8进行分配的。我们将那些不是通过V8分配的内存称为堆外内存。</p> <p>这里我们将前面的useMem()方法稍微改造一下，将Array变为Buffer，将size变大，每一次构造200MB的对象，相关代码如下：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> <span class="token function-variable function">useMem</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> size <span class="token operator">=</span> <span class="token number">200</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> buffer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Buffer</span><span class="token punctuation">(</span>size<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> size<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    buffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> buffer<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>重新执行该代码，得到的输出结果如下所示：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>Process<span class="token punctuation">:</span> heapTotal <span class="token number">6.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.82</span> <span class="token constant">MB</span> rss <span class="token number">19.38</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">4.73</span> <span class="token constant">MB</span> rss <span class="token number">221.38</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">4.74</span> <span class="token constant">MB</span> rss <span class="token number">422.06</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">10.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">4.26</span> <span class="token constant">MB</span> rss <span class="token number">622.88</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">10.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">4.27</span> <span class="token constant">MB</span> rss <span class="token number">823.28</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">10.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">4.03</span> <span class="token constant">MB</span> rss <span class="token number">1023.71</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">1224.61</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">1425.00</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.85</span> <span class="token constant">MB</span> rss <span class="token number">1625.40</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">1825.79</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.85</span> <span class="token constant">MB</span> rss <span class="token number">2026.20</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">11.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.85</span> <span class="token constant">MB</span> rss <span class="token number">2226.59</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">2425.51</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">2625.90</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">2826.30</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
Process<span class="token punctuation">:</span> heapTotal <span class="token number">8.23</span> <span class="token constant">MB</span> heapUsed <span class="token number">3.84</span> <span class="token constant">MB</span> rss <span class="token number">3026.20</span> <span class="token constant">MB</span>
<span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span><span class="token operator">--</span>
</code></pre></div><p>我们看到15次循环都完整执行，并且三个内存占用值与前一个示例完全不同。在改造后的输出结果中，heapTotal与heapUsed的变化极小，唯一变化的是rss的值，并且该值已经远远超过V8的限制值。这其中的原因是Buffer对象不同于其他对象，它不经过V8的内存分配机制，所以也不会有堆内存的大小限制。</p> <p><strong>这意味着利用堆外内存可以突破内存限制的问题。</strong></p> <p>为何Buffer对象并非通过V8分配？这在于Node并不同于浏览器的应用场景。在浏览器中，Javascript直接处理字符串即可满足绝大多数的业务需求，而Node则需要处理网络流和文件I/O流，操作字符串远远不能满足传输的性能需求。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>从上面的介绍可以得知，Node的内存构成主要由通过V8进行分配的部分和Node自行分配的部分。受V8的垃圾回收限制的主要是V8的堆内存。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/v8-memory-mechanism/furtherReading/" class="prev router-link-active">高效使用内存</a></span> <span class="next"><a href="/v8-memory-mechanism/furtherReading/LargeMemoryApplication.html">大内存应用</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/v8-memory-mechanism/assets/js/app.f97e74ef.js" defer></script><script src="/v8-memory-mechanism/assets/js/2.086987ff.js" defer></script><script src="/v8-memory-mechanism/assets/js/9.faddb988.js" defer></script>
  </body>
</html>
